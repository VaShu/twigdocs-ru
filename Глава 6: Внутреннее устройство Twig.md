Twig является очень гибким шаблонизатором и вы достаточно просто можете его усовершенствовать. Помните, что перед тем, как изменять ядро Twig, поработайте с расширениями, которые являются основной для дальнейшего расширения возможностей Twig и с их помощью большая часть возможностей может быть реализована. Эта глава будет полезна тем, кому интересно, как же устроен Twig под капотом.

###### Как работает Twig?

Отображение шаблонов Twig может быть разделено на 4 последовательных ключевых шага:

- Загрузка шаблона: если шаблон уже скомпилирован, то переходим на этап выполнения, в противном случае:
  - Лексический анализатор разбивает шаблон на небольшие блоки для упрощения обработки;
  - Парсер преобразует поток токенов (блоков) в дерево узлов (AST);
  - Компилятор преобразует AST в PHP-код.
- Этап выполнения: означает вызов метода ```display()``` скомпилированного шаблона и передачу контекста.

###### Лексический анализатор

Лексический анализатор разбивает исходный код шаблона на мелкие блоки и формирует поток из этих блоков (каждый токен представляет собой экземпляр класса ```Twig_Token```, а каждый поток - экземпляр класса ```Twig_TokenStream```). Лексический анализатор по-умолчанию распознаёт 13 видов токенов:

- ```Twig_Token::BLOCK_START_TYPE, Twig_Token::BLOCK_END_TYPE```: ограничитель блоков ```{%%}```;
- ```Twig_Token::VAR_START_TYPE, Twig_Token::VAR_END_TYPE```: ограничитель переменных ```{{}}```;
- ```Twig_Token::TEXT_TYPE```: текст вне выражения;
- ```Twig_Token::NAME_TYPE```: имя в выражении;
- ```Twig_Token::NUMBER_TYPE```: число в выражении;
- ```Twig_Token::STRING_TYPE```: строка в выражении;
- ```Twig_Token::OPERATOR_TYPE```: оператор;
- ```Twig_Token::PUNCTUATION_TYPE```: символ пунктуации;
- ```Twig_Token::INTERPOLATION_START_TYPE, Twig_Token::INTERPOLATION_END_TYPE```: разделитель для интерполяции строк;
- ```Twig_Token::EOF_TYPE```: завершение шаблона.

Вы можете вручную преобразовать исходный код шаблона в поток токенов вызвав метод ```tokenize()``` среды окружения:

```php
$stream = $twig->tokenize(new Twig_Source($source, $identifier));
```

В экземпляре класса ```Twig_TokenStream``` реализован метод ```_toString()```, который позволяет отобразить текстовое представление объекта потока:

```php
echo $stream . "\n";
```

Вот как будет выглядеть текстовое представление шаблона с содержимым ```Hello {{ name }}```:

```
TEXT_TYPE(Hello )
VAR_START_TYPE()
NAME_TYPE(name)
VAR_END_TYPE()
EOF_TYPE()
```

Лексический анализатор (```Twig_Lexer```) может быть изменён через вызов метода ```setLexer()``` среды окружения:

```php
$twig->setLexer($lexer);
```

###### Парсер

Парсер преобразует поток токенов в [AST (Abstract Syntaxt Tree)](https://ru.wikipedia.org/wiki/%D0%90%D0%B1%D1%81%D1%82%D1%80%D0%B0%D0%BA%D1%82%D0%BD%D0%BE%D0%B5_%D1%81%D0%B8%D0%BD%D1%82%D0%B0%D0%BA%D1%81%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%BE%D0%B5_%D0%B4%D0%B5%D1%80%D0%B5%D0%B2%D0%BE), или дерево услов (экземпляр класса ```Twig_Node_Module```). В ядре определены такие узлы как ```for```, ```if``` и т.д.

Можно в ручном режиме преобразовать поток токенов в дерево узлов через вызов метода окружения - ```parse()```:

```php
$nodes = $twig->parse($stream);
```

Отображение строкового представления узлов:

```
echo $nodes . "\n";
```

Вот как будет выглядеть преобразование уже знакомого нам кода ```Hello {{ name }}```:

```
 Twig_Node_Module(
  Twig_Node_Text(Hello )
  Twig_Node_Print(
    Twig_Node_Expression_Name(name)
  )
 )
```

Парсер по-умолчанию (```Twig_TokenParser```) может быть изменён через вызов метода окружения ```setParser()```:

```php
$twig->setParser($parser);
```

###### Компилятор

Последний шаг выполняется компилятором. На входе компилятор получает дерево узлов и генерирует PHP-представление для выполнения при вызове отображения.

Вы можете в ручном режиме скомпилировать дерево узлов в PHP-код через вызов метода окружения ```compile()```:

```php
$php = $twig->compile($nodes);
```

Сгенерированный код для шаблона ```Hello {{ name }}``` будет выглядеть следующим образом (результат генерации будет зависеть от используемой версии Twig):

```php
/* Hello {{ name }} */
class __TwigTemplate_1121b6f109fe93ebe8c6e22e3712bceb extends Twig_Template {
  protected function doDisplay(array $context, array $blocks = array()) {
    // line 1
    echo "Hello ";
    echo twig_escape_filter($this->env, (isset($context["name"]) ? $context["name"] : null), "html", null, true);
  }
  // some more code
}
```

Компилятор по-умолчанию (```Twig_Compiler```) может быть изменён через метод окружения ```setCompiler()```:

```php
$twig->setCompiler($compiler);
```
