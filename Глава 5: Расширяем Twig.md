
Twig может быть расширен различными способами - добавлением новых тегов, фильтров, тестов, операторов, глобальных переменных и функций. Присутствует возможность расширить сам парсер.

Первая часть этой главы расскажет о том, как просто и быстро можно расширить возможности Twig. Если у вас возникнет желание поделиться своим расширением с сообществом, то о том, как это сделать вы узнаете в конце этой секции. 

Перед тем как приступить к расширению возможностей Twig необходимо понять разницу между имеющимися ключевыми подходами к разработке расширения и ситуациях, в которых их необходимо использовать.

Во-первых, стоит иметь ввиду, что в Twig присутствуют две ключевые языковые структуры:

- ```{% %}```: используется для выполнения команд
- ```{{ }}```: используется для вывода значения выражения

Чтобы лучше понять причины по которым Twig использует такое кол-во точек входа, разберём пример с генератором ```Lorem ispum```, который на входе должен получать кол-во слов необходимое для генерирования:

Мы можем создать ```lipsum```-тег:

```twig
{% lipsum 40 %}
```

Это будет работать, однако использование тега для таких целей не является хорошим решением, по трём причинам:

- ```lipsum``` не является языковой конструкцией
- тег что-то выводит
- тег недостаточно гибок и не может быть использован в выражениях

```twig
{{ 'some text' ~ {% lipsum 40 %} ~ ' some more text' }}
```

В действительно, редки случаи, когда вам необходимо будет создавать теги; и это хорошие новости потому, что создание расширений тегов является самой сложной темой.

Попробуем использовать ```lipsum``` в качестве фильтра:

```twig
{{ 40|lipsum }}
```

Это будет работать, но выглядит странно. Фильтр предназначен для преобразования значений, вместо этого мы используем значение 40 для генерирации строки и вывода результата (40 - это аргумент для фильтра, а не значение, которые мы хотим преобразовать).

Дальше, попробуем ```lipsum``` в качестве функции:

```twig
{{ lipsum(40) }}
```

Вот мы и нашли то, что искали! Для данного конкретного примера, расширение Twig функцией является оптимальным вариантом. Генерируемое значение может быть использовано в выражениях:

```twig
{{ 'some text' ~ lipsum(40) ~ 'some more text' }}

{{ set text = lipsum(40) }}
```

Последнее, но не менее важное замечание: мы можем использовать глобальный объект с методом для генерирования нужного нам текста:

```twig
{{ text.lipsum(40) }}
```

Хорошим тоном считается использование функций для решения частых задач, а глобальные объекты для всего остального.

Держите в голове следующее, если вдруг решитесь расширять Twig:

Что | Сложность реализации | Как часто | Когда
----|-----|----|----
macro|тривиально|часто|генерирование содержимого
global|тривиально|часто|вспомогательные объекты
function|тривиально|часто|генерирование содержимого
filter|тривиально|часто|преобразование значений
tag|сложно|редко|языковые структуры (DSL)
test|тривиально|редко|логические проверки
operator|тривиально|редко|преобразование значений

###### Глобальные переменные

Глобальная переменна аналогично обычной переменной, лишь с одним различием - она доступна во всех шаблонах и макросах.

```php
$twig = new Twig_Environment($loader);
$twig->addGlobal('text', new Text());
```

После этого переменная ```text``` станет доступна во всех шаблонах:

```twig
{{ text.lipsum(40) }}
```

###### Фильтры

Создавать фильтры настолько же просто, насколько просто связать имя переменно с вызываемой функцией:

```php
// анонимная функция
$filter = new Twig_Filter('rot13', function ($string){
  return str_rot13($string);
});

// или просто PHP-функция
$filter = new Twig_Filter('rot13', 'str_rot13');

// или статичный метод класса
$filter = new Twig_Filter('rot13', ['SomeClass', 'rot13Filter']);
$filter = new TwigFilter('rot13', 'SomeClass::rot13Filter');

// или метод экземпляра
$filter = new Twig_Filter('rot13', [$this, 'rot13Filter']);
// данный метод требует реализации во время исполнения
$filter = new Twig_Filter('rot13', ['SomeClass', 'rot13Filter'])
```

Первый передаваемый параметр в ```Twig_Filter``` - название фильтра, которое будет использоваться в шаблонах; второй параметр - что именно будет вызываться.

После объявления фильтра - добавьте его в среду окружения:

```php
$twig = new Twig_Environment($loader);
$twig->addFilter($filter);
```

А вот как воспользоваться фильтром в шаблоне:

```twig
{{ 'Twig'|rot13 }}
```

Когда происходит вызов из Twig, PHP-вызываемая функция или метод получают в качестве первого аргумента вычисленное значение до ```|```, а в качестве дополнительных - перечисленные в ```()```.

Например:

```twig
{{ 'TWIG'|lower }}
{{ now|date('Y/m/d') }}
```

... будет скомпилировано в нечто подобное:

```twig
<? echo strtolower('TWIG') ?>
<? echo twig_date_format($now, 'Y/m/d') ?>
```

Последний аргумент при создании экземпляра класса ```Twig_Filter``` - массив опций:

```php
$filter = new Twig_Filter('rot13', 'str_rot13', $options);
```

###### Фильтры окружения

Если в создаваемом фильтре необходимо получить доступ к переменной окружения, установите опцию ```needs_environment``` в ```true```, Twig передаст текущее окружения в качестве первого аргумента при вызове фильтра:

```php
$filter = new Twig_Filter('rot13', function (Twig_Environment $env, $string) {
  // например, получим текущую кодировку
  $charset = $env->getCharset();
  
  return str_rot13($string);
}, ['needs_environment' => true]);
```
